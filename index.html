<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qwtabim — کارتی ئەنجامی قوتابی</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kurdish:wght@100..900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    /* Define font family for the whole app */
    .kurdish-font, [dir="rtl"] { font-family: "Noto Sans Kurdish", Arial, sans-serif; }
    body { background: #f3f4f6; }
    /* Custom styling for input placeholder */
    input::placeholder { font-family: "Noto Sans Kurdish", Arial, sans-serif; }

    /* card print styling for cleaner PDF */
    .card-pdf { width: 450px; padding: 30px; box-sizing: border-box; }
    @media print {
      body { background: white; }
    }
  </style>
</head>
<body class="min-h-screen p-6 kurdish-font">

    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4 kurdish-font">
      <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span id="loadingText" class="text-slate-700">دروستکردنی PDF... تکایە چاوەڕێ بکە</span>
    </div>
  </div>

  <header class="max-w-6xl mx-auto text-center mb-6">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Qwtabim — دۆزینەوەی کارتی ئەنجام</h1>
    <p class="text-sm text-slate-500 mt-2">تەنها بە کۆدی قوتابی (ID) بگەڕێ بۆ دۆزینەوەی ئەنجام.</p>
  </header>

  <main class="max-w-6xl mx-auto">

        <section class="bg-white rounded-xl p-4 shadow mb-6">
      <div class="flex flex-col md:flex-row gap-3 items-center justify-center">

        <div class="w-full md:w-1/3">
          <label for="searchInput" class="block text-sm mb-1">گەڕان بە ژمارەی قوتابی (ID)</label>
          <input id="searchInput" type="text" placeholder="ژمارەی قوتابی بنووسە (بۆ نموونە: 123)" class="w-full border rounded px-3 py-2" />
        </div>

        <div class="flex gap-2 mt-auto">
          <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">گەڕان</button>
        </div>
      </div>

      <p id="info" class="text-xs text-slate-500 mt-3 text-center">بۆ ئەنجام وەرگرتنەوە، تکایە کۆدی قوتابی بنووسە و گەڕان بکە.</p>
    </section>

        <section id="resultsSection" class="grid sm:grid-cols-1 lg:grid-cols-1 gap-4"></section>

  </main>

  <footer class="max-w-6xl mx-auto text-center mt-8 text-sm text-slate-500">
    © <span id="year"></span> Qwtabim
  </footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // 1. DATAY WANAKAN (7 WANAKA)
  // Max score for all subjects is 100
  const fixedSubjects = [
    { name: "کوردی", max: 100 },
    { name: "عەرەبی", max: 100 },
    { name: "فیزیا", max: 100 },
    { name: "کیمیا", max: 100 },
    { name: "بیرکاری", max: 100 },
    { name: "زیندەوەرزانی", max: 100 },
    { name: "ئینگلیزی", max: 100 }
  ];

  // 2. DATAY QUTABIYAN (BA NAW U NMRY CHESPRAW)
  // The length of the Scores array must match the length of fixedSubjects (7 scores)
  const rawStudentsData = [
    { 
      "ID": "123", 
      "Name": "محمد بریندار", 
      "Grade": "12 زانستی",
      "Scores": [100, 99, 90, 85, 95, 90, 85] 
    },
    { 
      "ID": "124", 
      "Name": "ئازاد کرم", 
      "Grade": "12 زانستی",
      "Scores": [98, 90, 95, 90, 88, 95, 100] 
    },
    { 
      "ID": "125", 
      "Name": "سلام نزار", 
      "Grade": "12 زانستی",
      "Scores": [85, 80, 75, 70, 65, 60, 55] 
    }
  ];
  

  // Prepare data: Combine student info with fixed subjects and actual scores
  const students = rawStudentsData.map(s => {
    const name = String(s.Name || '').trim();
    const id = String(s.ID || '').trim();
    
    // Map scores from array to subject objects
    const results = fixedSubjects.map((subject, index) => {
      return {
        subject: subject.name,
        max: subject.max,
        final: s.Scores[index] !== undefined ? s.Scores[index] : 0 // Use the provided score, or 0 if missing
      };
    });

    return {
      name: name,
      nameLower: name.toLowerCase(),
      grade: String(s.Grade || 'نادیار').trim(),
      id: id,
      results: results,
    };
  }).filter(s => s.name && s.id);


  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const resultsSection = document.getElementById('resultsSection');
  const loadingModal = document.getElementById('loadingModal');
  const loadingText = document.getElementById('loadingText');


  // Utility: normalize input (digits arabic-indic -> latin)
  const ARABIC_INDIC = "٠١٢٣٤٥٦٧٨٩";
  const LATIN = "0123456789";
  function toLatinDigits(str) {
    return String(str || '').replace(/[٠-٩]/g, d => LATIN[ARABIC_INDIC.indexOf(d)]);
  }

  // Escape HTML (safety)
  function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Show/Hide loading modal
  function setLoading(show, text = 'دروستکردنی PDF...') {
    loadingText.textContent = text;
    loadingModal.style.display = show ? 'flex' : 'none';
    document.querySelectorAll('button').forEach(btn => {
      if (btn.id !== 'searchBtn') { 
        btn.disabled = show;
      } else {
        btn.disabled = false;
      }
    });
  }
  
  // Function to generate the results table HTML
  function generateResultsTable(results) {
    let totalScore = 0;
    let maxTotal = 0;
    let overallPass = true;
    
    const rows = results.map(r => {
      totalScore += r.final;
      maxTotal += r.max;
      
      // Pass/Fail logic: assuming 50% needed to pass each subject
      const isPassed = r.final >= (r.max / 2);
      if (!isPassed) overallPass = false;
      
      return `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2 text-right w-1/3">${escapeHtml(r.subject)}</td>
          <td class="px-4 py-2 text-center font-bold ${isPassed ? 'text-green-600' : 'text-red-600'}">${escapeHtml(r.final)}</td>
          <td class="px-4 py-2 text-center">${escapeHtml(r.max)}</td>
        </tr>
      `;
    }).join('');
    
    const averagePercentage = (totalScore / maxTotal) * 100;
    // Final result logic: Must have overall 50% AND pass all individual subjects
    const finalResult = (averagePercentage >= 50 && overallPass) ? 'دەرچوو' : 'دەرنەچوو';

    return `
      <div class="mt-4">
        <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-slate-700">ئەنجامی وانەکان</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white text-sm border">
            <thead>
              <tr class="bg-gray-100 border-b">
                <th class="px-4 py-2 text-right w-1/3">وانە</th>
                <th class="px-4 py-2 text-center">نمرە</th>
                <th class="px-4 py-2 text-center">کۆی گشتی (Max)</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      </div>
      <div class="mt-6 pt-3 border-t-2 border-slate-700 space-y-2">
        <p class="text-md font-bold text-slate-800 flex justify-between">
          <span>کۆی گشتی نمرەکان:</span>
          <span class="${totalScore/maxTotal < 0.5 ? 'text-red-600' : 'text-green-600'}">${totalScore} / ${maxTotal}</span>
        </p>
        <p class="text-3xl font-extrabold flex justify-between p-3 rounded bg-gray-50 border shadow-inner">
          <span>ئەنجامی کۆتایی:</span>
          <span class="${finalResult === 'دەرچوو' ? 'text-green-700' : 'text-red-700'}">${finalResult}</span>
        </p>
      </div>
  `;
  }

  // Render cards for a list
  function renderResults(list) {
    resultsSection.innerHTML = '';
    if (!list || list.length === 0) {
      resultsSection.innerHTML = '<div class="col-span-full bg-white p-6 rounded shadow text-center text-slate-600">هیچ ئەنجامێک نەدۆزرایەوە بەم کۆدە. تکایە ID ڕاست بنووسە.</div>';
      return;
    }

    list.forEach(s => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow p-6 flex flex-col justify-between max-w-2xl mx-auto';
      
      const resultsHtml = generateResultsTable(s.results);

      card.innerHTML = `
        <div class="text-right">
          <h1 class="text-2xl font-bold text-blue-800 border-b pb-2 mb-4">کارتی ئەنجامی قوتابی</h1>
          <p class="text-md text-slate-700 mb-2">ناوی قوتابی: <span class="font-bold">${escapeHtml(s.name)}</span></p>
          <p class="text-md text-slate-700 mb-2">پۆل: <span class="font-bold">${escapeHtml(s.grade)}</span></p>
          <p class="text-md text-slate-700">ژمارەی قوتابی (ID): <span class="font-bold text-red-600">${escapeHtml(s.id)}</span></p>
        </div>
