<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qwtabim — گەڕان و کارتی قوتابی</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Kurdish:wght@100..900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    /* Define font family for the whole app */
    .kurdish-font, [dir="rtl"] { font-family: "Noto Sans Kurdish", Arial, sans-serif; }
    body { background: #f3f4f6; }
    /* Custom styling for input placeholder */
    input::placeholder { font-family: "Noto Sans Kurdish", Arial, sans-serif; }

    /* card print styling for cleaner PDF */
    .card-pdf { width: 380px; padding: 20px; box-sizing: border-box; }
    @media print {
      body { background: white; }
    }
  </style>
</head>
<body class="min-h-screen p-6 kurdish-font">

    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4 kurdish-font">
      <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span id="loadingText" class="text-slate-700">دروستکردنی PDF... تکایە چاوەڕێ بکە</span>
    </div>
  </div>

  <header class="max-w-6xl mx-auto text-center mb-6">
    <h1 class="text-2xl md:text-3xl font-bold text-slate-800">Qwtabim — گەڕان بە کۆدی قوتابی (ID) و دابەزاندنی PDF</h1>
    <p class="text-sm text-slate-500 mt-2">ئەم بەشە پشت بە داتای ناوخۆیی (چەسپاو) دەبەستێت.</p>
  </header>

  <main class="max-w-6xl mx-auto">

        <section class="bg-white rounded-xl p-4 shadow mb-6">
      <div class="flex flex-col md:flex-row gap-3 items-center justify-center">

        <div class="w-full md:w-1/3">
          <label for="searchInput" class="block text-sm mb-1">گەڕان بە ژمارەی قوتابی (ID) یان ناو</label>
          <input id="searchInput" type="text" placeholder="ژمارەی قوتابی یان ناو بنووسە" class="w-full border rounded px-3 py-2" />
        </div>

        <div class="flex gap-2 mt-auto">
          <button id="searchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded transition">گەڕان</button>
          <button id="exportAllBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded transition">دانلودی هەموو کارتەکان (PDF)</button>
        </div>
      </div>

      <p id="info" class="text-xs text-slate-500 mt-3 text-center">ئێستا <span id="studentCount">...</span> قوتابی لە داتای ناوخۆییدا هەیە.</p>
    </section>

        <section id="resultsSection" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></section>

  </main>

  <footer class="max-w-6xl mx-auto text-center mt-8 text-sm text-slate-500">
    © <span id="year"></span> Qwtabim
  </footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // 1. DATAY QUTABIYAN LA EXCEL-awa CHESPENDRT
  // BKOYAWA: ID, Name, Grade kewistn
  const rawStudentsData = [
    { "ID": "1001", "Name": "شیلان ئەحمەد", "Grade": "12A" },
    { "ID": "1002", "Name": "ئارام جەمال", "Grade": "11C" },
    { "ID": "1003", "Name": "سۆزان ڕێبوار", "Grade": "10B" },
    { "ID": "1004", "Name": "کاوە حەیدەر", "Grade": "12A" },
    { "ID": "1005", "Name": "هەردی عومەر", "Grade": "9D" },
    { "ID": "1006", "Name": "ئازاد محەمەد", "Grade": "11A" },
    { "ID": "1007", "Name": "لەیلا کەریم", "Grade": "10C" },
    { "ID": "1008", "Name": "ڕێباز خالید", "Grade": "12B" },
    { "ID": "1009", "Name": "پەرواز فایەق", "Grade": "9A" },
    { "ID": "1010", "Name": "زانا عەبدولڕەحمان", "Grade": "11B" },
    { "ID": "1011", "Name": "نەرمین سۆفی", "Grade": "12C" },
    { "ID": "1012", "Name": "بڵند مەجید", "Grade": "11A" },
    { "ID": "1013", "Name": "مەریەم تاهیر", "Grade": "10B" },
    { "ID": "1014", "Name": "سەفین هەڵمەت", "Grade": "12A" },
    { "ID": "1015", "Name": "شادی جەلیل", "Grade": "9C" }
  ];

  // Prepare data for better searching and consistent keys
  const students = rawStudentsData.map(s => {
    const name = String(s.Name || '').trim();
    const id = String(s.ID || '').trim();
    return {
      name: name,
      nameLower: name.toLowerCase(),
      grade: String(s.Grade || 'نادیار').trim(),
      id: id,
    };
  }).filter(s => s.name && s.id); // Filter out rows missing Name or ID


  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const resultsSection = document.getElementById('resultsSection');
  const exportAllBtn = document.getElementById('exportAllBtn');
  const loadingModal = document.getElementById('loadingModal');
  const loadingText = document.getElementById('loadingText');


  // Utility: normalize input (digits arabic-indic -> latin)
  const ARABIC_INDIC = "٠١٢٣٤٥٦٧٨٩";
  const LATIN = "0123456789";
  function toLatinDigits(str) {
    return String(str || '').replace(/[٠-٩]/g, d => LATIN[ARABIC_INDIC.indexOf(d)]);
  }

  // Escape HTML (safety)
  function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Show/Hide loading modal
  function setLoading(show, text = 'دروستکردنی PDF...') {
    loadingText.textContent = text;
    loadingModal.style.display = show ? 'flex' : 'none';
    // Disable all buttons while loading
    document.querySelectorAll('button').forEach(btn => {
      btn.disabled = show;
    });
  }

  // Render cards for a list
  function renderResults(list) {
    resultsSection.innerHTML = '';
    if (!list || list.length === 0) {
      resultsSection.innerHTML = '<div class="col-span-full bg-white p-6 rounded shadow text-center text-slate-600">هیچ ئەنجامێک نەدۆزرایەوە</div>';
      return;
    }

    list.forEach(s => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-2xl shadow p-4 text-center flex flex-col justify-between';
      // No Creator field in card markup
      card.innerHTML = `
        <div>
          <h2 class="text-lg font-semibold text-slate-800">${escapeHtml(s.name)}</h2>
          <p class="text-sm text-slate-500 mt-2">پۆل: <span class="font-medium">${escapeHtml(s.grade)}</span></p>
          <p class="text-sm text-slate-500">ژمارەی قوتابی: <span class="font-medium">${escapeHtml(s.id)}</span></p>
        </div>
        <div class="mt-4 flex gap-2 justify-center">
          <button class="downloadBtn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition">دانلود PDF</button>
        </div>
      `;
      // Attach download handler
      const btn = card.querySelector('.downloadBtn');
      btn.addEventListener('click', () => downloadCardAsPDF(s, btn));
      resultsSection.appendChild(card);
    });
  }

  // Convert a single card DOM (or data) to PDF and download
  async function downloadCardAsPDF(student, button) {
    setLoading(true, `دروستکردنی کارتی ${student.id}...`);

    // build printable markup (better control for PDF)
    const wrapper = document.createElement('div');
    wrapper.className = 'card-pdf';
    // No Creator field in printable PDF markup
    wrapper.innerHTML = `
      <div style="font-family: 'Noto Sans Kurdish', Arial, sans-serif; direction: rtl; padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
        <h2 style="font-size:22px;margin:0 0 10px 0; font-weight: 600;">${escapeHtml(student.name)}</h2>
        <p style="margin:0 0 5px 0; font-size: 14px;">پۆل: <span style="font-weight: 500;">${escapeHtml(student.grade)}</span></p>
        <p style="margin:0 0 5px 0; font-size: 14px;">ژمارەی قوتابی: <span style="font-weight: 500;">${escapeHtml(student.id)}</span></p>
      </div>
    `;

    // html2pdf options (A7-ish size)
    const opt = {
      margin:       [5, 5, 5, 5],
      filename:     `${toLatinDigits(student.id || 'student')}_${student.nameLower || 'card'}.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 3, useCORS: true },
      jsPDF:        { unit: 'mm', format: [105, 74], orientation: 'portrait' }
    };
    try {
      await html2pdf().set(opt).from(wrapper).save();
    } catch (error) {
      console.error("PDF download failed:", error);
      alert('هەڵەیەک ڕوویدا لە کاتی داونلۆدی PDF. تکایە دووبارە هەوڵ بدەوە.');
    } finally {
      setLoading(false);
    }
  }

  // Export all visible cards into a single PDF (one per page)
  async function exportAllAsOnePDF(list) {
    if (!list || list.length === 0) { alert('هیچ ئەنجامێک نییە بۆ داونلۆد'); return; }

    setLoading(true, `دروستکردنی ${list.length} کارت لە یەک فایلدا...`);

    const container = document.createElement('div');
    container.style.direction = 'rtl';
    // append each student as page-sized div (A4)
    list.forEach((s) => {
      const page = document.createElement('div');
      page.style.padding = '20px';
      page.style.pageBreakAfter = 'always';
      page.style.width = '210mm';
      page.style.height = '297mm';
      // No Creator field in batch PDF markup
      page.innerHTML = `
        <div style="font-family: 'Noto Sans Kurdish', Arial, sans-serif; border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
          <h2 style="font-size:24px;margin:0 0 10px 0; font-weight: 700;">${escapeHtml(s.name)}</h2>
          <p style="margin:0 0 5px 0;">پۆل: <span style="font-weight: 500;">${escapeHtml(s.grade)}</span></p>
          <p style="margin:0 0 5px 0;">ژمارەی قوتابی: <span style="font-weight: 500;">${escapeHtml(s.id)}</span></p>
        </div>
      `;
      container.appendChild(page);
    });

    const opt = {
      margin:       [0, 0, 0, 0],
      filename:     `students_all_cards.pdf`,
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    try {
      await html2pdf().set(opt).from(container).save();
    } catch
