<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qwtabim — کارتی ئەنجامی قوتابی</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    /* NRT-REG FONT INTEGRATION */
    @font-face {
      font-family: 'NRT Reg';
      src: url('NRT-Reg.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap; 
    }

    /* Define font family for the whole app, prioritizing NRT Reg */
    .kurdish-font, [dir="rtl"] { font-family: "NRT Reg", "Noto Sans Kurdish", Arial, sans-serif; }
    
    /* Apply modern background effect (blur and gradient overlay) */
    body { 
      position: relative; 
      background: #f3f4f6;
      background-image: url('Gemini_Generated_Image_b9w8g4b9w8g4b9w8.jpg');
      background-size: cover;
      background-attachment: fixed;
      transition: background-color 0.3s;
    } 
    
    /* Background overlay for blurring, dimming, and controlling opacity */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(243, 244, 246, 0.6);
      backdrop-filter: blur(8px); 
      z-index: -1;
      transition: background-color 0.3s;
    }

    /* DARK MODE STYLING */
    .dark body { background: #1f2937; } 
    .dark body::before { background-color: rgba(31, 41, 55, 0.8); } 
     
    /* Custom styling for input placeholder */
    input::placeholder { font-family: "NRT Reg", "Noto Sans Kurdish", Arial, sans-serif; color: #9ca3af; }

    /* card print styling for cleaner PDF */
    .card-pdf { width: 450px; padding: 30px; box-sizing: border-box; }
    @media print {
      body { background: white; }
      body::before { display: none; }
    }
    
    /* Logo positioning */
    .logo-container {
      position: absolute;
      top: 24px; 
      left: 24px; 
      z-index: 20; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }

    /* Theme toggle position for RTL: Top-Right */
    .theme-toggle-container {
      position: absolute;
      top: 24px;
      right: 24px;
      z-index: 30;
    }
    
    /* Added CSS for the Creator Link Button */
    .creator-link-container {
      position: absolute;
      top: 120px; /* Adjust vertical position below the logo */
      left: 24px;
      z-index: 20;
    }
    .creator-link {
      background-color: #fca311; /* Orange/Yellow Color */
      color: #1f2937; /* Dark text */
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      text-decoration: none;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
      transition: background-color 0.3s, transform 0.1s;
    }
    .creator-link:hover {
      background-color: #fbbf24;
      transform: scale(1.05);
    }


    /* Modern table styling */
    .modern-table th { background-color: #3b82f6; color: white; }
    .modern-table tr:nth-child(even) { background-color: #f3f4f6; }
    .dark .modern-table tr:nth-child(even) { background-color: #374151; }
  </style>
</head>
<body class="min-h-screen p-6 kurdish-font">

    <a href="#" class="logo-container" aria-label="گەڕانەوە بۆ ماڵەوە">
    <img src="Gemini_Generated_Image_b9w8g4b9w8g4b9w8.jpg" alt="Logo" class="h-20 w-20 rounded-full shadow-xl object-cover" /> 
    <span class="text-3xl font-extrabold text-slate-800 dark:text-gray-100 tracking-wider transition">Qwtabim</span>
  </a>

    <div class="creator-link-container">
    <a href="creator.html" class="creator-link">
      زانیاری دروستکەر
    </a>
  </div>

    <div class="theme-toggle-container">
    <button id="themeToggle" class="bg-white dark:bg-gray-700 p-2 rounded-full shadow-lg transition transform hover:scale-110">
      <svg id="sunIcon" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
      </svg>
      <svg id="moonIcon" class="h-6 w-6 text-gray-400 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
      </svg>
    </button>
  </div>

    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4 kurdish-font">
      <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span id="loadingText" class="text-slate-700">دروستکردنی PDF... تکایە چاوەڕێ بکە</span>
    </div>
  </div>

  <header class="max-w-4xl mx-auto text-center mb-12 mt-12 bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl">
    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-gray-50 transition">سیستەمی کارتی ئەنجام</h1>
    <p class="text-md text-slate-600 dark:text-slate-400 mt-3">گەڕان بە کۆدی قوتابی بۆ دۆزینەوەی ئەنجامەکان.</p>
  </header>

  <main class="max-w-4xl mx-auto">

        <section class="bg-white dark:bg-gray-800 rounded-xl p-6 shadow-xl mb-10">
      <div class="flex flex-col md:flex-row gap-4 items-center justify-center">

        <div class="w-full md:w-2/3">
          <label for="searchInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">گەڕان بە ژمارەی قوتابی (ID)</label>
          <input id="searchInput" type="text" placeholder="کۆدی قوتابی بنووسە (بۆ دۆزینەوەی ئەنجام)" class="w-full border-2 border-blue-300 dark:border-blue-600 dark:bg-gray-700 dark:text-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition shadow-sm" />
        </div>

        <div class="w-full md:w-1/3 flex items-end">
          <button id="searchBtn" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold px-4 py-3 rounded-lg shadow-md transition transform hover:scale-[1.02]">گەڕان</button>
        </div>
      </div>

      <p id="info" class="text-xs text-slate-500 dark:text-slate-400 mt-4 text-center">بۆ ئەنجام وەرگرتنەوە، تکایە کۆدی قوتابی بنووسە و گەڕان بکە.</p>
    </section>

        <section id="resultsSection" class="grid sm:grid-cols-1 lg:grid-cols-1 gap-6"></section>

  </main>

  <footer class="max-w-6xl mx-auto text-center mt-12 mb-6 text-sm text-slate-500 dark:text-slate-400">
    © <span id="year"></span> Qwtabim
  </footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // Theme toggle logic
  const themeToggle = document.getElementById('themeToggle');
  const moonIcon = document.getElementById('moonIcon');
  const sunIcon = document.getElementById('sunIcon');
  const body = document.body;

  // Initial theme check
  if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    body.classList.add('dark');
    moonIcon.classList.remove('hidden');
    sunIcon.classList.add('hidden');
  } else {
    sunIcon.classList.remove('hidden');
    moonIcon.classList.add('hidden');
  }

  themeToggle.addEventListener('click', () => {
    if (body.classList.contains('dark')) {
      body.classList.remove('dark');
      localStorage.setItem('theme', 'light');
      sunIcon.classList.remove('hidden');
      moonIcon.classList.add('hidden');
    } else {
      body.classList.add('dark');
      localStorage.setItem('theme', 'dark');
      moonIcon.classList.remove('hidden');
      sunIcon.classList.add('hidden');
    }
  });

  
  // 1. DATAY WANAKAN (7 WANAKA)
  const fixedSubjects = [
    { name: "کوردی", max: 100 },
    { name: "عەرەبی", max: 100 },
    { name: "فیزیا", max: 100 },
    { name: "کیمیا", max: 100 },
    { name: "بیرکاری", max: 100 },
    { name: "زیندەوەرزانی", max: 100 },
    { name: "ئینگلیزی", max: 100 }
  ];

  // 2. DATAY QUTABIYAN (4 QUTABI CHESPRAW)
  const rawStudentsData = [
    { 
      "ID": "123", 
      "Name": "محمد بریندار", 
      "Grade": "12 زانستی",
      "Scores": [90, 85, 95, 90, 85, 90, 95] 
    },
    { 
      "ID": "124", 
      "Name": "ئازاد کرم", 
      "Grade": "12 زانستی",
      "Scores": [95, 90, 88, 95, 100, 99, 90] 
    },
    { 
      "ID": "125", 
      "Name": "سلام نزار", 
      "Grade": "12 زانستی",
      "Scores": [80, 75, 70, 65, 60, 55, 50] 
    },
    { 
      "ID": "126", 
      "Name": "بشار شێر", 
      "Grade": "12 زانستی",
      "Scores": [75, 70, 65, 60, 55, 50, 45] 
    }
  ];
  

  // Prepare data: Combine student info with fixed subjects and actual scores
  const students = rawStudentsData.map(s => {
    const name = String(s.Name || '').trim();
    const id = String(s.ID || '').trim();
    
    // Map scores from array to subject objects
    const results = fixedSubjects.map((subject, index) => {
      return {
        subject: subject.name,
        max: subject.max,
        final: s.Scores[index] !== undefined ? s.Scores[index] : 0 // Use the provided score, or 0 if missing
      };
    });

    return {
      name: name,
      nameLower: name.toLowerCase(),
      grade: String(s.Grade || 'نادیار').trim(),
      id: id,
      results: results,
    };
  }).filter(s => s.name && s.id);


  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const resultsSection = document.getElementById('resultsSection');
  const loadingModal = document.getElementById('loadingModal');
  const loadingText = document.getElementById('loadingText');


  // Utility: normalize input (digits arabic-indic -> latin)
  const ARABIC_INDIC = "٠١٢٣٤٥٦٧٨٩";
  const LATIN = "0123456789";
  
  function toLatinDigits(str) {
    str = String(str || '').replace(/\s/g, ''); 
    return str.replace(/[٠-٩]/g, d => LATIN[ARABIC_INDIC.indexOf(d)]);
  }

  // Escape HTML (safety)
  function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Show/Hide loading modal
  function setLoading(show, text = 'دروستکردنی PDF...') {
    loadingText.textContent = text;
    loadingModal.style.display = show ? 'flex' : 'none';
    document.querySelectorAll('button').forEach(btn => {
      if (btn.id !== 'searchBtn') { 
        btn.disabled = show;
      } else {
        btn.disabled = false;
      }
    });
  }
  
  // Function to generate the results table HTML
  function generateResultsTable(results) {
    let totalScore = 0;
    let maxTotal = 0;
    let overallPass = true;
    
    const rows = results.map(r => {
      totalScore += r.final;
      maxTotal += r.max;
      
      // Pass/Fail logic: assuming 50% needed to pass each subject
      const isPassed = r.final >= (r.max / 2);
      if (!isPassed) overallPass = false;
      
      return `
        <tr class="border-b dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition">
          <td class="px-4 py-3 text-right w-2/3">${escapeHtml(r.subject)}</td>
          <td class="px-4 py-3 text-center font-bold ${isPassed ? 'text-green-500' : 'text-red-500'}">${escapeHtml(r.final)}</td>
        </tr>
      `;
    }).join('');
    
    const averagePercentage = (totalScore / maxTotal) * 100;
    // Final result logic: Must have overall 50% AND pass all individual subjects
    const finalResult = (averagePercentage >= 50 && overallPass) ? 'دەرچوو' : 'دەرنەچوو';

    return `
      <div class="mt-8">
        <h3 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-700 dark:text-gray-300">ئەنجامی وانەکان</h3>
        <div class="overflow-x-auto border dark:border-gray-700 rounded-lg shadow-inner">
          <table class="min-w-full bg-white dark:bg-gray-800 text-sm modern-table rounded-lg">
            <thead>
              <tr class="bg-blue-600 border-b dark:border-blue-700">
                <th class="px-4 py-3 text-right w-2/3 font-bold text-white">وانە</th>
                <th class="px-4 py-3 text-center font-bold text-white">نمرە</th>
              </tr>
            </thead>
            <tbody class="text-gray-700 dark:text-gray-200">
              ${rows}
            </tbody>
          </table>
        </div>
      </div>
      <div class="mt-8 pt-4 border-t-2 border-slate-300 dark:border-gray-600 space-y-4">
        <p class="text-lg font-bold text-slate-800 dark:text-gray-200 flex justify-between">
          <span>کۆی گشتی نمرەکان:</span>
          <span class="font-extrabold ${totalScore/maxTotal < 0.5 ? 'text-red-500' : 'text-green-500'}">${totalScore} / ${maxTotal}</span>
        </p>
        <p class="text-lg font-bold text-slate-800 dark:text-gray-200 flex justify-between">
          <span>تێکڕای نمرە:</span>
          <span class="font-extrabold ${averagePercentage < 50 ? 'text-red-500' : 'text-green-500'}">${averagePercentage.toFixed(2)}%</span>
        </p>
        <div class="text-3xl font-extrabold flex justify-center p-4 rounded-lg bg-blue-100 dark:bg-blue-900 border-2 border-blue-400 dark:border-blue-700 shadow-2xl">
          <span class="text-slate-800 dark:text-gray-100 ml-4">ئەنجامی کۆتایی:</span>
          <span class="${finalResult === 'دەرچوو' ? 'text-green-600' : 'text-red-600'}">${finalResult}</span>
        </div>
      </div>
  `;
  }

  // Render cards for a list
  function renderResults(list) {
    resultsSection.innerHTML = '';
    if (!list || list.length === 0) {
      resultsSection.innerHTML = '<div class="col-span-full bg-white dark:bg-gray-800 p-8 rounded-xl shadow-xl text-center text-slate-600 dark:text-gray-300">هیچ ئەنجامێک نەدۆزرایەوە بەم کۆدە. تکایە ID ڕاست بنووسە.</div>';
      return;
    }

    list.forEach(s => {
      const card = document.createElement('div');
      card.className = 'bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-8 flex flex-col justify-between max-w-2xl mx-auto transition';
      
      const resultsHtml = generateResultsTable(s.results);

      card.innerHTML = `
        <div class="text-right border-b pb-4 border-slate-300 dark:border-gray-700">
          <h1 class="text-3xl font-bold text-blue-600">کارتی ئەنجامی قوتابی</h1>
        </div>
        <div class="mt-4 text-slate-700 dark:text-gray-300 space-y-2">
          <p class="text-lg">ناوی قوتابی: <span class="font-extrabold">${escapeHtml(s.name)}</span></p>
          <p class="text-lg">پۆل: <span class="font-extrabold">${escapeHtml(s.grade)}</span></p>
          <p class="text-lg">ژمارەی قوتابی (ID): <span class="font-extrabold text-red-600 dark:text-red-500">${escapeHtml(s.id)}</span></p>
        </div>
        
        ${resultsHtml}

        <div class="mt-8 border-t pt-4 border-slate-300 dark:border-gray-700 flex gap-4 justify-end">
          <button class="downloadBtn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold px-5 py-2 rounded-lg shadow-lg transition transform hover:scale-105">دانلودی PDF</button>
        </div>
      `;
      // Attach download handler
      const btn = card.querySelector('.downloadBtn');
      btn.addEventListener('click', () => downloadCardAsPDF(s));
      resultsSection.appendChild(card);
    });
  }

  // Convert a single card DOM (or data) to PDF and download
  async function downloadCardAsPDF(student) {
    setLoading(true, `دروستکردنی کارتی ئەنجام بۆ ${student.name} (${student.id})...`);

    const wrapper = document.createElement('div');
    wrapper.className = 'card-pdf';
    
    let totalScore = 0;
    let maxTotal = 0;
    let overallPass = true;
    
    const rowsHtml = student.results.map(r => {
      totalScore += r.final;
      maxTotal += r.max;
      const isPassed = r.final >= (r.max / 2);
      if (!isPassed) overallPass = false;

      return `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 8px; text-align: right;">${escapeHtml(r.subject)}</td>
          <td style="padding: 8px; text-align: center; font-weight: bold; color: ${isPassed ? '#10b981' : '#ef4444'};">${escapeHtml(r.final)}</td>
        </tr>
      `;
    }).join('');
    
    const averagePercentage = (totalScore / maxTotal) * 100;
    const finalResult = (averagePercentage >= 50 && overallPass) ? 'دەرچوو' : 'دەرنەچوو';

    wrapper.innerHTML = `
      <div style="font-family: 'NRT Reg', Arial, sans-serif; direction: rtl; padding: 15px; border: 1px solid #1f2937; border-radius: 8px; width: 190mm; margin: 0 auto; background-color: #ffffff;">
        <div style="text-align: center; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; margin-bottom: 15px;">
          <h1 style="font-size: 26px; margin: 0; font-weight: 700; color: #1e40af;">کارتی ئەنجامی قوتابی</h1>
        </div>
        <div style="margin-bottom: 15px; padding: 0 10px;">
          <p style="margin: 0 0 5px 0; font-size: 17px;">ناوی قوتابی: <span style="font-weight: 700;">${escapeHtml(student.name)}</span></p>
          <p style="margin: 0 0 5px 0; font-size: 17px;">پۆل: <span style="font-weight: 700;">${escapeHtml(student.grade)}</span></p>
          <p style="margin: 0 0 5px 0; font-size: 17px;">ژمارەی قوتابی (ID): <span style="font-weight: 700; color: #dc2626;">${escapeHtml(student.id)}</span></p>
        </div>

        <div style="border: 1px solid #ccc; border-radius: 4px; overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse; font-size: 15px;">
            <thead style="background-color: #3b82f6; color: white;">
              <tr style="border-bottom: 2px solid #3b82f6;">
                <th style="padding: 10px; text-align: right; width: 50%;">وانە</th>
                <th style="padding: 10px; text-align: center; width: 50%;">نمرە</th>
              </tr>
            </thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 25px; padding-top: 15px; border-top: 2px solid #ccc; padding: 0 10px;">
          <p style="font-size: 19px; font-weight: 700; display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>کۆی گشتی نمرەکان:</span>
            <span style="font-weight: 800; color: ${totalScore/maxTotal < 0.5 ? '#dc2626' : '#16a34a'};">${totalScore} / ${maxTotal}</span>
          </p>
          <p style="font-size: 19px; font-weight: 700; display: flex; justify-content: space-between; margin-bottom: 15px;">
            <span>تێکڕای نمرە (ڕێژەی سەدی):</span>
            <span style="font-weight: 800; color: ${averagePercentage < 50 ? '#dc2626' : '#16a34a'};">${averagePercentage.toFixed(2)}%</span>
          </p>
          <div style="font-size: 24px; font-weight: 800; text-align: center; padding: 12px; background-color: #eff6ff; border: 2px solid #93c5fd; border-radius: 8px;">
            <span style="color: #1f2937;">ئەنجامی کۆتایی:</span>
            <span style="color: ${finalResult === 'دەرچوو' ? '#10b981' : '#ef4444'}; margin-right: 10px;">${finalResult}</span>
          </div>
        </div>
      </div>
    `;

    // html2pdf options (Format is A4 to ensure single page output)
    const opt = {
      margin:       [10, 10, 10, 10],
      filename:     `${toLatinDigits(student.id || 'student')}_${student.name}_result_card.pdf`, 
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 3, useCORS: true },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' } 
    };
    
    try {
      await html2pdf().set(opt).from(wrapper).save();
    } catch (error) {
      console.error("PDF download failed:", error);
      alert('هەڵەیەک ڕوویدا لە کاتی داونلۆدی PDF. تکایە دووبارە هەوڵ بدەوە.');
    } finally {
      setLoading(false);
    }
  }

  // Search only by ID (exact match)
  function search(query) {
    const q = String(query || '').trim();
    
    // Use toLatinDigits to normalize input query and trim spaces
    const qLatin = toLatinDigits(q);
    
    if (!qLatin) return []; 

    // Filter for exact ID match
    const result = students.filter(s => {
      // Ensure the student ID is also normalized/trimmed before comparison
      const id = toLatinDigits(String(s.id || '')); 
      return id === qLatin; // Exact match on normalized ID
    });
    return result;
  }

  // Event handlers
  searchBtn.addEventListener('click', () => {
    const q = searchInput.value.trim();
    const res = search(q);
    renderResults(res);
  });

  // Allow Enter key in search to trigger
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      searchBtn.click();
    }
  });

  // Initial setup
  document.getElementById('studentCount').textContent = students.length;
  renderResults([]); // Start with no results

</script>
</body>
</html>
